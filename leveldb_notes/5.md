# Memtable

这次到了memtable中，也就是leveldb的内存中数据结构

[参考文章](https://leveldb-handbook.readthedocs.io/zh/latest/memorydb.html)

跳表的思路就是通过概率来进行平衡，而非平衡树那样强制平衡。从而使得我们的实现可以简化很多。

![20220619094537](https://picsheep.oss-cn-beijing.aliyuncs.com/pic/20220619094537.png)

上面这个例子就是增加指针的链表。让我们可以稳定按照2的次幂的步数进行跳跃。但是缺点就是很不容易处理，因为插入的时候要去仔细计算我们跳过了多少节点，从而判断是否增加额外指针。

一个拥有k个指针的结点成为k层结点。50%的结点为1层节点，25%的结点为2层节点。如果保证每层结点的分布概率相同，则仍然可以拥有相同的查询效率。

![20220619095059](https://picsheep.oss-cn-beijing.aliyuncs.com/pic/20220619095059.png)

有关更加细节的讲解可以看参考文章。这里我们开始看代码

skiplist是在`skiplist.h`中实现的，提供的核心接口就是Insert，以及Iterator

![20220619115939](https://picsheep.oss-cn-beijing.aliyuncs.com/pic/20220619115939.png)

compare是用来比较的functor，核心在他的类型。

arena是用来分配内存的结构。head为链表头。

max height是最大高度。我们会在插入的时候更新最大高度。这样读取的时候才能根据最大高度去遍历。读到stale value是没关系的，相当于没有读到这个新的node

rnd则是用来生成随机数，在构建新结点的时候使用。